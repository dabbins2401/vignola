<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>THE PLEASE USE ME VIGNOLA TUNER</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root {
  --bg: #0a1a33;
  --bg2: #11284d;
  --text: #ffffff;
  --subtle: #c7cdd8;
  --accent: #8fb3ff;
  --success: #4ade80;
  --danger: #ff6b6b;
  --radius: 20px;
  --shadow: 0 14px 40px rgba(0,0,0,0.4);
}

.light {
  --bg: #ffffff;
  --bg2: #f2f4f8;
  --text: #0a1a33;
  --subtle: #4a5568;
  --accent: #2b6cb0;
  --success: #2f855a;
  --danger: #c53030;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: "Inter", sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  justify-content: center;
  padding: 20px;
  transition: background 0.3s, color 0.3s;
}

.app {
  width: 100%;
  max-width: 960px;
  background: var(--bg2);
  border-radius: var(--radius);
  padding: 20px;
  box-shadow: var(--shadow);
  border: 1px solid rgba(255,255,255,0.08);
}

/* HEADER */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
  text-align: center;
}

.brand {
  flex: 1 1 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 14px;
}

.brand img {
  height: 96px;
}

.title {
  font-size: 1.6rem;
  font-weight: 700;
}

.subtitle {
  font-size: 0.9rem;
  color: var(--subtle);
}

.mode-btn {
  background: var(--text);
  color: var(--bg);
  border: none;
  padding: 10px 18px;
  border-radius: 999px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 10px;
}

/* CONTROL BAR */
.control-bar {
  margin-top: 18px;
  background: var(--bg);
  padding: 14px;
  border-radius: 14px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  border: 1px solid rgba(255,255,255,0.1);
}

.control-bar select,
.control-bar input {
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid var(--subtle);
  background: var(--bg2);
  color: var(--text);
  width: 100%;
}

.mic-btn {
  background: var(--text);
  color: var(--bg);
  border: none;
  padding: 12px;
  border-radius: 999px;
  font-weight: 600;
  cursor: pointer;
}

/* STATUS */
.status {
  margin-top: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--subtle);
}

.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--danger);
}

.status-dot.live {
  background: var(--success);
}

/* CARD */
.card {
  margin-top: 20px;
  background: var(--bg);
  padding: 20px;
  border-radius: var(--radius);
  border: 1px solid rgba(255,255,255,0.1);
}

/* TUNER GAUGE */
.gauge {
  position: relative;
  width: 100%;
  max-width: 260px;
  height: 140px;
  margin: 0 auto;
}

.gauge-arc {
  width: 100%;
  height: 100%;
  border-radius: 300px 300px 0 0;
  border: 6px solid var(--subtle);
  border-bottom: none;
  position: absolute;
  top: 0;
  left: 0;
}

.tick {
  position: absolute;
  width: 2px;
  height: 12px;
  background: var(--subtle);
  left: 50%;
  transform-origin: bottom center;
}

.tick-label {
  position: absolute;
  font-size: 0.7rem;
  color: var(--subtle);
  transform: translateX(-50%);
}

.needle {
  position: absolute;
  width: 3px;
  height: 100px;
  background: var(--accent);
  left: 50%;
  bottom: 0;
  transform-origin: bottom center;
  transition: transform 0.08s ease-out;
}

.readout {
  margin-top: 20px;
  text-align: center;
}

.note-display {
  font-size: 1.8rem;
  font-weight: 700;
}

.freq-display {
  font-size: 0.9rem;
  color: var(--subtle);
}

.cents-pill {
  margin-top: 10px;
  display: inline-block;
  padding: 6px 12px;
  border-radius: 999px;
  border: 1px solid var(--subtle);
}

.cents-pill.in-tune { border-color: var(--success); color: var(--success); }
.cents-pill.sharp { border-color: var(--danger); color: var(--danger); }
.cents-pill.flat { border-color: var(--accent); color: var(--accent); }

/* METRONOME */
.metronome-controls {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.metronome-controls input,
.metronome-controls select {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid var(--subtle);
  background: var(--bg2);
  color: var(--text);
}

.metronome-btn {
  padding: 10px;
  border-radius: 999px;
  border: none;
  background: var(--accent);
  color: var(--bg);
  font-weight: 600;
}

.metronome-visual {
  margin-top: 10px;
  height: 10px;
  border-radius: 999px;
  background: rgba(255,255,255,0.08);
  overflow: hidden;
}

.metronome-pulse {
  height: 100%;
  width: 0%;
  background: var(--accent);
  transition: width 0.05s ease-out;
}

/* DRUM MACHINE */
.drum-main {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.drum-pads {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}

.pad {
  padding: 18px;
  border-radius: 12px;
  background: #1b2438;
  border: 1px solid rgba(255,255,255,0.15);
  text-align: center;
  font-size: 1rem;
  cursor: pointer;
  transition: 0.1s ease;
}

.pad.active {
  background: var(--accent);
  color: var(--bg);
  transform: translateY(1px);
}

.drum-controls {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.drum-controls input,
.drum-controls select {
  width: 100%;
}

.drum-grid {
  overflow-x: auto;
}

.step-grid {
  border-collapse: collapse;
  width: 600px;
  font-size: 0.8rem;
}

.step-grid th,
.step-grid td {
  border: 1px solid rgba(255,255,255,0.1);
  padding: 4px;
  text-align: center;
}

.step {
  width: 24px;
  height: 24px;
  border-radius: 4px;
  background: #1b2438;
  cursor: pointer;
}

.step.active {
  background: var(--accent);
}

.step.current {
  box-shadow: 0 0 0 2px var(--success);
}
</style>
</head>

<body class="dark">
<div class="app">

  <div class="header">
    <div class="brand">
      <img src="shark.png" alt="Shark Logo">
      <div class="title">THE PLEASE USE ME VIGNOLA TUNER</div>
      <div class="subtitle">Tuner • Metronome • Drum Machine</div>
    </div>
    <button class="mode-btn" id="modeBtn">Light Mode</button>
  </div>

  <div class="control-bar">
    <select id="tuningSelect">
      <option value="auto">Auto (Closest Note)</option>
      <option value="standard">Guitar — Standard</option>
      <option value="dropd">Drop D</option>
      <option value="openg">Open G</option>
      <option value="ukulele">Ukulele</option>
      <option value="bass">Bass</option>
      <option value="custom">Custom</option>
    </select>

    <input id="customInput" placeholder="D2 A2 D3 G3" style="display:none;">
    <button id="applyCustom" style="display:none;">Apply</button>

    <button id="micButton" class="mic-btn">Enable Mic</button>
  </div>

  <div class="status">
    <div id="statusDot" class="status-dot"></div>
    <span id="statusText">Microphone is off.</span>
  </div>

  <div class="card">
    <div class="gauge">
      <div class="gauge-arc"></div>

      <div class="tick" style="transform: translateX(-50%) rotate(-40deg); top: 10px;"></div>
      <div class="tick" style="transform: translateX(-50%) rotate(-20deg); top: 10px;"></div>
      <div class="tick" style="transform: translateX(-50%) rotate(0deg); top: 10px;"></div>
      <div class="tick" style="transform: translateX(-50%) rotate(20deg); top: 10px;"></div>
      <div class="tick" style="transform: translateX(-50%) rotate(40deg); top: 10px;"></div>

      <div class="tick-label" style="left: 20%; top: 110px;">-50</div>
      <div class="tick-label" style="left: 35%; top: 85px;">-25</div>
      <div class="tick-label" style="left: 50%; top: 65px;">0</div>
      <div class="tick-label" style="left: 65%; top: 85px;">+25</div>
      <div class="tick-label" style="left: 80%; top: 110px;">+50</div>

      <div id="needle" class="needle"></div>
    </div>

    <div class="readout">
      <div id="noteDisplay" class="note-display">--</div>
      <div id="freqDisplay" class="freq-display">-- Hz</div>
      <div id="centsDisplay" class="cents-pill">Waiting…</div>
    </div>
  </div>

  <div class="card">
    <div class="metronome-controls">
      <input type="number" id="bpmInput" value="120" min="30" max="260">
      <select id="timeSigSelect">
        <option value="4">4/4</option>
        <option value="3">3/4</option>
        <option value="6">6/8</option>
      </select>
      <button class="metronome-btn" id="metronomeToggle">Start</button>
    </div>
    <div class="metronome-visual">
      <div class="metronome-pulse" id="metronomePulse"></div>
    </div>
  </div>

  <div class="card">
    <div class="drum-main">

      <div class="drum-pads">
        <div class="pad" data-sound="kick">Kick</div>
        <div class="pad" data-sound="snare">Snare</div>
        <div class="pad" data-sound="hihat">Hi‑Hat</div>
        <div class="pad" data-sound="tom">Tom</div>
        <div class="pad" data-sound="ride">Ride</div>
        <div class="pad" data-sound="rim">Rim</div>
      </div>

      <div class="drum-controls">
        <input type="number" id="drumBpm" value="120" min="30" max="260">
        <input type="range" id="swing" min="0" max="0.5" step="0.05" value="0">
        <select id="patternLength">
          <option value="16" selected>16</option>
        </select>
        <button class="metronome-btn" id="drumToggle">Play</button>
      </div>

      <div class="drum-grid">
        <table class="step-grid" id="stepGrid">
          <thead><tr><th>Sound</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

    </div>
  </div>

</div>

<script>
/* MODE */
document.getElementById("modeBtn").onclick = () => {
  document.body.classList.toggle("light");
  document.getElementById("modeBtn").textContent =
    document.body.classList.contains("light") ? "Dark Mode" : "Light Mode";
};

/* TUNING */
const PRESETS = {
  auto: [],
  standard: ["E2","A2","D3","G3","B3","E4"],
  dropd: ["D2","A2","D3","G3","B3","E4"],
  openg: ["D2","G2","D3","G3","B3","D4"],
  ukulele: ["G4","C4","E4","A4"],
  bass: ["E1","A1","D2","G2"]
};

let activeTuning = [];

function noteToFreq(note) {
  const m = note.match(/^([A-G]#?)(\d)$/i);
  if (!m) return null;
  const name = m[1].toUpperCase();
  const octave = +m[2];
  const SEMI = {C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11};
  const n = SEMI[name] + (octave + 1) * 12;
  return 440 * Math.pow(2, (n - 69) / 12);
}

const tuningSelect = document.getElementById("tuningSelect");
const customInput = document.getElementById("customInput");
const applyCustom = document.getElementById("applyCustom");

tuningSelect.onchange = () => {
  const v = tuningSelect.value;
  if (v === "custom") {
    customInput.style.display = "block";
    applyCustom.style.display = "block";
    activeTuning = [];
  } else {
    customInput.style.display = "none";
    applyCustom.style.display = "none";
    activeTuning = PRESETS[v].map(noteToFreq).filter(Boolean);
  }
};

applyCustom.onclick = () => {
  activeTuning = customInput.value.trim().split(/\s+/).map(noteToFreq).filter(Boolean);
};

/* TUNER AUDIO */
let audioContext = null;
let analyser = null;
let micStream = null;
let dataBuffer = null;
let rafId = null;

const micButton = document.getElementById("micButton");
const statusDot = document.getElementById("statusDot");
const statusText = document.getElementById("statusText");
const needle = document.getElementById("needle");
const noteDisplay = document.getElementById("noteDisplay");
const freqDisplay = document.getElementById("freqDisplay");
const centsDisplay = document.getElementById("centsDisplay");

micButton.onclick = async () => {
  if (!audioContext || audioContext.state === "closed") startTuner();
  else stopTuner();
};

async function startTuner() {
  try {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    await audioContext.resume();
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const src = audioContext.createMediaStreamSource(micStream);
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 2048;
    dataBuffer = new Float32Array(analyser.fftSize);
    src.connect(analyser);

    statusDot.classList.add("live");
    statusText.textContent = "Listening…";
    micButton.textContent = "Disable Mic";

    loopTuner();
  } catch (e) {
    statusText.textContent = "Mic error";
  }
}

function stopTuner() {
  if (rafId) cancelAnimationFrame(rafId);
  if (micStream) micStream.getTracks().forEach(t => t.stop());
  if (audioContext) audioContext.close();
  audioContext = null;

  statusDot.classList.remove("live");
  statusText.textContent = "Microphone is off.";
  micButton.textContent = "Enable Mic";
}

function detectPitch(buf, sr) {
  let rms = 0;
  for (let i = 0; i < buf.length; i++) rms += buf[i] * buf[i];
  rms = Math.sqrt(rms / buf.length);
  if (rms < 0.008) return -1;

  let best = -1, bestCorr = 0;
  for (let o = 40; o < 1000; o++) {
    let c = 0;
    for (let i = 0; i < buf.length - o; i++) c += buf[i] * buf[i + o];
    if (c > bestCorr) bestCorr = c, best = o;
  }
  return best > 0 ? sr / best : -1;
}

function loopTuner() {
  if (!analyser || !dataBuffer) return;
  analyser.getFloatTimeDomainData(dataBuffer);
  const f = detectPitch(dataBuffer, audioContext.sampleRate);
  if (f !== -1) updateTunerUI(f);
  rafId = requestAnimationFrame(loopTuner);
}

function updateTunerUI(freq) {
  freqDisplay.textContent = freq.toFixed(2) + " Hz";

  const noteNum = Math.round(12 * (Math.log(freq / 440) / Math.log(2)) + 69);
  const names = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  const name = names[noteNum % 12];
  const octave = Math.floor(noteNum / 12) - 1;
  noteDisplay.textContent = name + octave;

  const refFreq = 440 * Math.pow(2, (noteNum - 69) / 12);
  const cents = 1200 * Math.log(freq / refFreq) / Math.log(2);
  const c = Math.round(cents);

  let angle = (c / 50) * 40;
  angle = Math.max(-40, Math.min(40, angle));
  needle.style.transform = `rotate(${angle}deg)`;

  centsDisplay.className = "cents-pill";
  if (Math.abs(c) <= 3) {
    centsDisplay.textContent = "In tune";
    centsDisplay.classList.add("in-tune");
  } else if (c > 3) {
    centsDisplay.textContent = `${c} sharp`;
    centsDisplay.classList.add("sharp");
  } else {
    centsDisplay.textContent = `${c} flat`;
    centsDisplay.classList.add("flat");
  }
}

/* METRONOME */
const bpmInput = document.getElementById("bpmInput");
const timeSigSelect = document.getElementById("timeSigSelect");
const metronomeToggle = document.getElementById("metronomeToggle");
const metronomePulse = document.getElementById("metronomePulse");

let metronomeCtx = null;
let metronomeTimer = null;
let metronomeBeat = 0;

function metronomeClick() {
  if (!metronomeCtx) metronomeCtx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = metronomeCtx.createOscillator();
  const gain = metronomeCtx.createGain();
  const now = metronomeCtx.currentTime;
  osc.frequency.value = metronomeBeat === 0 ? 1200 : 800;
  gain.gain.setValueAtTime(0.3, now);
  gain.gain.exponentialRampToValueAtTime(0.001, now + 0.08);
  osc.connect(gain).connect(metronomeCtx.destination);
  osc.start(now);
  osc.stop(now + 0.1);
}

function startMetronome() {
  const bpm = parseInt(bpmInput.value, 10) || 120;
  const beatsPerBar = parseInt(timeSigSelect.value, 10);
  const interval = (60 / bpm) * 1000;

  if (!metronomeCtx) metronomeCtx = new (window.AudioContext || window.webkitAudioContext)();
  metronomeCtx.resume();

  metronomeBeat = 0;
  metronomeToggle.textContent = "Stop";

  if (metronomeTimer) clearInterval(metronomeTimer);
  metronomeTimer = setInterval(() => {
    metronomeClick();
    metronomePulse.style.width = "100%";
    setTimeout(() => metronomePulse.style.width = "0%", 80);
    metronomeBeat = (metronomeBeat + 1) % beatsPerBar;
  }, interval);
}

function stopMetronome() {
  if (metronomeTimer) clearInterval(metronomeTimer);
  metronomeTimer = null;
  metronomeToggle.textContent = "Start";
  metronomePulse.style.width = "0%";
}

metronomeToggle.onclick = () => {
  if (metronomeTimer) stopMetronome();
  else startMetronome();
};

/* DRUM MACHINE */
const drumBpmInput = document.getElementById("drumBpm");
const swingInput = document.getElementById("swing");
const patternLengthSelect = document.getElementById("patternLength");
const stepGrid = document.getElementById("stepGrid");
const drumToggle = document.getElementById("drumToggle");
const pads = document.querySelectorAll(".pad");

const drumCtx = new (window.AudioContext || window.webkitAudioContext)();

const sounds = {
  kick: { freq: 80 },
  snare: { freq: 180 },
  hihat: { freq: 6000 },
  tom: { freq: 140 },
  ride: { freq: 900 },
  rim: { freq: 400 }
};

function playSound(name) {
  const cfg = sounds[name];
  if (!cfg) return;
  const osc = drumCtx.createOscillator();
  const gain = drumCtx.createGain();
  const now = drumCtx.currentTime;

  if (name === "kick") {
    osc.frequency.setValueAtTime(150, now);
    osc.frequency.exponentialRampToValueAtTime(50, now + 0.15);
  } else if (name === "snare") {
    osc.frequency.setValueAtTime(200, now);
  } else if (name === "hihat") {
    osc.type = "square";
    osc.frequency.setValueAtTime(cfg.freq, now);
  } else {
    osc.frequency.setValueAtTime(cfg.freq, now);
  }

  gain.gain.setValueAtTime(0.8, now);
  gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);

  osc.connect(gain).connect(drumCtx.destination);
  osc.start(now);
  osc.stop(now + 0.2);
}

pads.forEach(p => {
  p.addEventListener("mousedown", () => {
    const s = p.dataset.sound;
    p.classList.add("active");
    playSound(s);
  });
  p.addEventListener("mouseup", () => p.classList.remove("active"));
  p.addEventListener("mouseleave", () => p.classList.remove("active"));
});

/* Step sequencer grid: 6 sounds x 16 steps, default rock beat */
const soundOrder = ["kick","snare","hihat","tom","ride","rim"];
let patternLength = 16;
let steps = {};
let drumTimer = null;
let currentStep = 0;

function buildGrid() {
  patternLength = 16;
  steps = {};
  const theadRow = stepGrid.querySelector("thead tr");
  theadRow.innerHTML = "<th>Sound</th>";
  for (let i = 0; i < patternLength; i++) {
    const th = document.createElement("th");
    th.textContent = i + 1;
    theadRow.appendChild(th);
  }

  const tbody = stepGrid.querySelector("tbody");
  tbody.innerHTML = "";
  soundOrder.forEach(sound => {
    steps[sound] = new Array(patternLength).fill(false);
    const tr = document.createElement("tr");
    const label = document.createElement("td");
    label.textContent = sound;
    tr.appendChild(label);
    for (let i = 0; i < patternLength; i++) {
      const td = document.createElement("td");
      const div = document.createElement("div");
      div.className = "step";
      div.dataset.sound = sound;
      div.dataset.index = i;
      div.onclick = () => {
        const idx = parseInt(div.dataset.index, 10);
        const s = div.dataset.sound;
        steps[s][idx] = !steps[s][idx];
        div.classList.toggle("active", steps[s][idx]);
      };
      td.appendChild(div);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  });

  preloadRockBeat();
}

function preloadRockBeat() {
  // Kick on 1 and 3 (steps 0 and 8)
  steps.kick[0] = true;
  steps.kick[8] = true;
  // Snare on 2 and 4 (steps 4 and 12)
  steps.snare[4] = true;
  steps.snare[12] = true;
  // Hi-hat on 8ths: 0,2,4,6,8,10,12,14
  [0,2,4,6,8,10,12,14].forEach(i => steps.hihat[i] = true);
  // Ride on quarters: 0,4,8,12
  [0,4,8,12].forEach(i => steps.ride[i] = true);

  const tbody = stepGrid.querySelector("tbody");
  soundOrder.forEach((sound, rowIndex) => {
    const row = tbody.children[rowIndex];
    for (let i = 0; i < patternLength; i++) {
      const cell = row.children[i + 1];
      const div = cell.querySelector(".step");
      if (steps[sound][i]) div.classList.add("active");
    }
  });
}

buildGrid();

function startDrums() {
  const bpm = parseInt(drumBpmInput.value, 10) || 120;
  const swing = parseFloat(swingInput.value) || 0;
  const baseInterval = (60 / bpm) * 1000 / 4; // 16th notes

  if (drumTimer) clearTimeout(drumTimer);
  currentStep = 0;
  scheduleNextStep(baseInterval, swing);
  drumToggle.textContent = "Stop";
}

function scheduleNextStep(baseInterval, swing) {
  const tbody = stepGrid.querySelector("tbody");
  tbody.querySelectorAll(".step").forEach(el => el.classList.remove("current"));

  soundOrder.forEach((sound, rowIndex) => {
    if (steps[sound][currentStep]) {
      playSound(sound);
      const row = tbody.children[rowIndex];
      const cell = row.children[currentStep + 1];
      const div = cell.querySelector(".step");
      if (div) div.classList.add("current");
    }
  });

  const isOffbeat = currentStep % 2 === 1;
  const swingDelay = isOffbeat ? swing * baseInterval : 0;

  currentStep = (currentStep + 1) % patternLength;
  drumTimer = setTimeout(() => scheduleNextStep(baseInterval, swing), baseInterval + swingDelay);
}

function stopDrums() {
  if (drumTimer) clearTimeout(drumTimer);
  drumTimer = null;
  drumToggle.textContent = "Play";
  const tbody = stepGrid.querySelector("tbody");
  tbody.querySelectorAll(".step").forEach(el => el.classList.remove("current"));
}

drumToggle.onclick = () => {
  if (drumTimer) stopDrums();
  else startDrums();
};

/* Sync BPM between metronome and drums */
drumBpmInput.addEventListener("input", () => {
  bpmInput.value = drumBpmInput.value;
});
bpmInput.addEventListener("input", () => {
  drumBpmInput.value = bpmInput.value;
});
</script>

</body>
</html>
